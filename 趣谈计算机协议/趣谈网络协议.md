### 1.为什么要学习网络协议

通过网络协议，可以是机器间进行协作，完成更多的功能。

网络协议主要有5层：

<img src="趣谈网络协议.assets/image-20200720212035590.png" alt="image-20200720212035590" style="zoom:67%;" />

举例说明：打开浏览器，输入某购物网站的地址之后，浏览器会给你显示相应的页面，这是如何实现的呢？

它之所以会显示缤纷多彩的页面，是因为它收到了一段来自HTTP协议的“东西”，格式如下：

<img src="趣谈网络协议.assets/image-20200720200809976.png" alt="image-20200720200809976" style="zoom:67%;" />

<img src="趣谈网络协议.assets/image-20200720200629780.png" alt="image-20200720200629780" style="zoom:67%;" />

具体流程如下：

- 在浏览器输入例如www.baidu.com，这是一个URL，浏览器通过地址簿协议**DNS**或**HTTPDNS**查找。然后找到对应的IP地址，即互联网世界的“门牌号”。
- 知道了目标地址后，浏览器开始打包它的请求。对于普通的浏览请求，会使用HTTP协议；对于需要加密传输的，往往使用HTTPS协议。无论使用的哪个协议，都会写明具体内容：<img src="趣谈网络协议.assets/image-20200720201644439.png" alt="image-20200720201644439" style="zoom:50%;" />
- DNS、HTTP、HTTPS所在的层称为**应用层**，经过应用层封装后，浏览器会将应用层的包交给下一层去完成，通过socket网络编程实现。下一层是传输层，**传输层有两种协议**，一种是无连接的UDP，一种是面向连接的协议TCP。比如支付这种场景，一般就使用TCP协议。面向连接的意思是，TCP会保证这个包能到达目的地，如果不能到达，就会重新发送，直到到达。
- TCP协议中有两个端口，一个是浏览器监听的端口，一个是服务器监听的端口，**操作系统**往往通过**端口**判断它得到的包应给哪个进程。<img src="趣谈网络协议.assets/image-20200720203438250.png" alt="image-20200720203438250" style="zoom:67%;" />
- 传输层封装完毕后，浏览器会将包交给操作系统的网络层，**网络层**的协议是**IP协议**，在IP协议中会有源IP地址，即浏览器所在机器的IP地址和目标IP地址。<img src="趣谈网络协议.assets/image-20200720203717472.png" alt="image-20200720203717472" style="zoom:67%;" />
- 操作系统启动时，会被DHCP协议配置IP地址，而网关的IP地址通常是192.168.1.1。操作系统会在本地通信中通过ARP协议询问，网关回应MAC地址。<img src="趣谈网络协议.assets/image-20200720204546032.png" alt="image-20200720204546032" style="zoom:67%;" />
- 然后操作系统将IP包发给下一层，即MAC层。网卡将包发出去。由于这个包有MAC地址，因此它能够到达网关。
- 网关通常是一个路由器，收到包后根据路由表得到去目的IP的方法。
- 路由器连着许多个局域网，在每个局域网内部，都可以使用本地的地址MAC进行通信。
- 一旦跨越局域网，需要拿出IP头，表明源IP地址与目的IP地址。沟通的协议称为**路由协议**，常用的协议有OSPF和BGP。<img src="趣谈网络协议.assets/image-20200720205005968.png" alt="image-20200720205005968" style="zoom:67%;" />
- 而路由器与路由器之间是一个局域网，当网络包知道要转发去哪个路由器之后，还是要使用该局域网内部的MAC地址，通过下一个路由器的MAC地址，找到下一个路由器。
- 最后一个路由器知道目标IP是哪，于是通过局域网内通信得到相应的目标服务器的MAC地址，通过这个MAC地址找到目标的服务器。
- 目标服务器发现MAC地址对上了，就取下MAC头给操作系统的网络层；IP对上了就取下IP头，IP头里会写上一层封装的是TCP协议，然后将其交给传输层。
- 在传输层，对于收到的每个包，都会有回复表示收到了。若过一段时间没发到，发送端的TCP层会重新发送这个包，直到收到目的端收到的回复。
- 当网络包平安到达TCP层之后，TCP头中有目标端口号，通过这个端口号，可以找到比如电商网站的进程正在监听这个端口号，因此就会将这个包发给该进程。

<img src="趣谈网络协议.assets/image-20200720211238012.png" alt="image-20200720211238012" style="zoom: 67%;" />

通常接受请求的进程是个接待员，它负责统筹处理这个请求，而不是完成所有的工作。这个进程会通过RPC调用（远程过程调用），告诉比如管理订单的进程，管理支付的进程等。接待员不用担心中间的网络互联问题，会由RPC框架统一处理。RPC框架有多种，比如基于HTTP协议放在HTTP报文里的，有直接封装在TCP报文中的。

当接待员发现相应的进程都处理完毕后，回复给浏览器一个HTTPS的包告知完成。这个包就会像来的时候一样，经过传递到达起初的浏览器。



### 2.网络分层的含义是什么？

网络为什么要分层？因为复杂的程序都要分层，这是程序设计的要求。

`BIOS`的作用：读取硬盘的MBR启动扇区，将GRUB启动起来；然后将权力交给GRUB，加载作为根文件系统的initramfs文件；然后将权力交给内核，最后内核启动，初始化整个系统。

### 3.DNS协议

#### 1、传统DNS存在的问题

##### 1）域名缓存问题

由于本地DNS服务器能做一个本地缓存，当有其他客户端询问DNS转IP的映射时，可能这个映射关系已经变更了，但本地缓存没有变，因此返回的是错误的结果。

##### 2）域名转发问题

比如A运营商的客户，访问自己运营商的DNS服务器，若A运营商去权威DNS服务器查询，返回一个部署在A运营商的网站地址，这样针对相同运营商的访问，就会快很多。

若A运营商偷懒，将解析的请求转发给B运营商，B运营商去权威DNS服务器查询的话，DNS服务器返回的是在B运营商的网站地址，结果客户端每次访问都要跨运营商，速度就很慢。

#### 2、HTTPDNS

为了解决上述的问题，有了HTTPDNS，它不走传统的DNS解析，而是自己搭建基于HTTP协议的DNS服务器集群，分布在多个地点和多个运营商。

一般是手机应用，手机上嵌入支持HTTPDNS的SDK。当客户端需要DNS解析时，直接通过HTTP协议进行请求这个服务器集群，得到就近的地址。相当于它不依赖默认的DNS路径，自行查找。

<img src="趣谈网络协议.assets/image-20200824132522586.png" alt="image-20200824132522586" style="zoom:67%;" />

HTTPDNS主要解决的是**缓存设计**和**调度设计**问题。

##### 1、缓存设计

为了加快解析引入缓存，但是产生了缓存不及时更新导致访问错误的问题。传统的缓存在本地DNS服务器处，客户端难以解决。

而HTTPDNS在解析时使用HTTP请求，要实时更新时马上就能起作用。另一方面，本地维护缓存，放在客户端SDK处，过期时间、更新时间能自行控制。

##### 2、缓存设计模式

分为客户端、缓存、数据源三层。

1. 应用架构：即应用、缓存、数据库，常见的有Tomcat、Redis、MySQL
2. HTTPDNS：手机客户端、DNS缓存、HTTPDNS服务器

<img src="趣谈网络协议.assets/image-20200824133353512.png" alt="image-20200824133353512" style="zoom:50%;" />

SDK的缓存会严格按照缓存过期时间，若缓存没命中或已经过期，会发起一次解析，保障记录是更新的。此时直接调用HTTPDNS的接口（同步更新，对应cache-aside机制，先读缓存，同时将结果写入缓存），返回最新的记录，更新缓存。

<img src="趣谈网络协议.assets/image-20200824154934916.png" alt="image-20200824154934916" style="zoom:67%;" />

或者异步进行，添加一个解析任务到后台，由后台任务调用HTTPDNS的接口。对应refresh-ahead机制，业务应用仅仅访问缓存，当过期时定期刷新。

<img src="趣谈网络协议.assets/image-20200824155258866.png" alt="image-20200824155258866" style="zoom:67%;" />

##### 3、调度设计

客户端嵌入SDK，可以知道该手机准确的位置、运营商等信息，HTTPDNS服务器可以根据这些信息选择最佳的服务器返回。

若多个节点，客户端的SDK会收集网络请求数据如错误率、请求时间等质量数据，并发送到统计后台，进行分析并查看不同IP的服务质量。

应用还能通过调用HTTPDNS的管理接口，配置不同服务质量的优先级、权重，HTTPDNS根据这些策略算出排序，优先访问优质的、低时延的IP地址。

<img src="趣谈网络协议.assets/image-20200824161255690.png" alt="image-20200824161255690" style="zoom:67%;" />

### 4.数据中心

数据中心有一大堆服务器，被放在叫`机架(rack)`的架子上。数据中心的入口和出口都是**路由器**，它位于数据中心的边界，一般称为`边界路由器(border router)`。为了**高可用**，一般有多个。一般家庭只连接一个运营商的网络，为了高可用，当一个运营商出问题时，会连另一个运营商提供服务，因此数据中心的边界路由器一般**连接多个**运营商网络。

数据中心是路由协议中的`自治区域(AS)`，数据中心有对外提供服务的机器，通过`BGP协议`，**获取**内外互通的**路由信息**。这是**多线 BGP** 的概念。

由于数据中心机器非常多，因此塞满一机架时，需要**交换机**将这些服务器连接起来，它们可以互相通信。交换机一般放在机架顶端，被称为`TOR(top for rack)交换机`。这一层的交换机常常被称为`接入层(access layer)`。

<img src="趣谈网络协议.assets/image-20200911153937589.png" alt="image-20200911153937589" style="zoom:50%;" />

`汇聚交换机`相较于普通的，带宽更大，对性能的要求更高。

数据中心的每个链接都需要考虑高可用，因此每个机器至少需要两个网卡、两个网线插到TOR交换机上。但是两个网卡要工作的像一张网卡一样，这是`网卡绑定(bond)`。这需要服务器和交换机支持一种协议`LACP(link aggregation control protocol)`，它们互相通信，将多个网卡聚合为一个网卡，多个网线聚合成一个网线，在网线间进行复杂均衡，为高可用做准备。

<img src="趣谈网络协议.assets/image-20200911155144683.png" alt="image-20200911155144683" style="zoom:50%;" />

交换机也要保证高可用，因此使用一种技术叫`堆叠`。将多个交换机形成一个逻辑上的交换机，服务器通过多根线分配多个接入层交换机上。并且通过堆叠的私有协议，形成双活的连接方式。

<img src="趣谈网络协议.assets/image-20200911160304708.png" alt="image-20200911160304708" style="zoom:50%;" />

由于交换机对带宽要求更大，两个堆叠可能不够，可能四个堆叠。汇聚层将大量的计算节点连接在一起，形成一个集群，服务器通过二层互通，这一般称为一个`POD(point of delivery)`，即`可用区(available zone)`。

当节点数目多导致一个可用区放不下时，需要将多个可用区连在一起，连接多个可用区的称为**核心交换机**。

<img src="趣谈网络协议.assets/image-20200911161934824.png" alt="image-20200911161934824" style="zoom:50%;" />

核心交换机也要满足高可用，堆叠不足以满足吞吐量，因此需要部署多组核心交换机，核心和汇聚交换机间为了高可用，是`全互联模式`的。

#### 出现环路的处理方法

当为大二层且横向流量大的时候，要部署多个核心交换机，且和汇聚层全互连。此时**使用STP**只会使一组起作用，部署多组核心也无法扩大横向流量的能力。

<img src="趣谈网络协议.assets/image-20200911162816363.png" alt="image-20200911162816363" style="zoom:50%;" />

因此引入`TRILL(transparent interconnection of lots of link)，多链接透明互联协议`。它的基本思想是：二层环有问题，三层环没问题，就把三层的路由能力模拟在二层实现。

运行TRILL协议的交换机称为**RBridge**，是**具有路由转发特性**的网桥设备，只不过这个路由是**根据MAC地址**来的，不是根据IP来的。它通过链路状态协议运作，通过学习大二层的拓扑，知道访问哪个MAC往哪个网桥走，还能知道最短路径，进行负载均衡和高可用。

`分发树`将一个有环的图形成多棵树，不同的数有不同的VLAN，有的广播包从VLAN A广播，有的从VALN B广播，实现负载均衡和高可用。

对于数据中心的存储设备，会有存储网络用来连接`SAN和NAS`(https://wenku.baidu.com/view/75f44d7b31b765ce050814e2.html)。对于云计算，不使用SAN和NAS，使用部署在x86机器上的**软件定义存储**。这样可以和计算节点融合在一个机架上。

随着云计算以及大数据的发展，节点间需要经常性交互数据，因此需要经过交换机将数据从左到右这样交换，称为`东西流量`。为了解决东西流量的问题，演化出`叶脊网络(spine/leaf)`。

- 叶子交换机，直接连接物理服务器，L2/L3网络的分界点在叶子交换机，叶子交换机之上是三层网络
- 脊交换机，相当于核心交换机。叶脊之间通过ECMP动态选择路径。脊交换机相当于为叶子交换机提供L3路由网络。南北流量可以直接通过和叶子交换机并行的交换机到边界路由器去。

#### 重点

- 数据中心分为三层，服务器连接到接入层，然后是汇聚层，然后是核心层，最外面是边界服务器和安全设备。
- 数据中心的所有链路都需要高可用性，服务器需要绑定网卡，交换机需要堆叠，三层设备可以通过等价路由，二层设备通过TRILL协议。
- 东西流量相较于南北流量更重要，因而演化出叶脊网络结构。